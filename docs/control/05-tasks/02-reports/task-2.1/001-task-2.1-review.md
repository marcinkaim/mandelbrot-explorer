# Architecture Compliance Review (ACR) - 001

* **Date:** 2025-12-27
* **Task:** Task 2.1 (Orchestrator & SDL2)
* **Auditor:** Software Architect
* **Status:** ðŸ”´ CHANGES REQUIRED

## 1. Executive Summary
The implementation of Task 2.1 successfully establishes the rendering window and the multi-threaded architecture described in ADR-005. The separation between the UI Thread (`Run_UI_Loop`) and the Compute Thread (`Worker`) is correct. However, significant violations of Ada safety principles (unsafe pointer casting) and resource leaks (OpenGL objects) were detected.

## 2. Critical Findings (Must Fix)

### [CRIT-01] VRAM Resource Leak on Shutdown
* **Location:** `src/app/orchestrator.adb`, procedure `Shutdown`.
* **Issue:** The application explicitly destroys the SDL Window and Context but fails to release OpenGL resources allocated in `Initialize`.
* **Impact:** `VAO_Handle`, `PBO_Handle`, `Texture_Handle`, `VBO`, and `Shader_Program` remain allocated in VRAM/Driver state.
* **Recommendation:** Add explicit calls to `glDeleteBuffers`, `glDeleteVertexArrays`, `glDeleteTextures`, and `glDeleteProgram` inside the `Shutdown` procedure.

### [CRIT-02] Unsafe Pointer Arithmetic / Conversion
* **Location:** `src/app/orchestrator.adb`, lines 278-279 and 344-345.
* **Issue:** Usage of `Ada.Unchecked_Conversion` to cast `System.Address` to access types (`Job_Queue_Access`, `Context_Access`).
    ```ada
    -- BAD PRACTICE
    function To_Queue_Ptr is new Ada.Unchecked_Conversion (System.Address, Job_Queue_Access);
    ...
    Self.Worker.Start (To_Queue_Ptr (Self.Queue'Address), ...);
    ```
* **Reasoning:** This bypasses Ada's type safety and aliasing rules completely. It treats memory as raw bytes, typical of C, but unnecessary in Ada.
* **Recommendation:** Use `access all` types properly or `Unchecked_Access` attribute if accessibility checks fail. Ideally, pass the access types directly without converting to `System.Address`.

## 3. Warnings (Should Fix)

### [WARN-01] Missing OpenGL Cleanup Imports
* **Location:** `src/binding/opengl_thin.ads`.
* **Issue:** The package imports creation functions (e.g., `glGenVertexArrays`) but misses some deletion counterparts (e.g., `glDeleteTextures`, `glDeleteVertexArrays` is present but `glDeleteProgram` was missing in logic).
* **Recommendation:** Ensure all "Gen/Create" functions have a corresponding "Delete" function imported and used.

### [WARN-02] Hardcoded Resolution
* **Location:** `src/app/orchestrator.ads`.
* **Issue:** `Width` and `Height` are initialized to 800x600 but not dynamically updated on window resize events in `Run_UI_Loop`.
* **Impact:** Resizing the window stretches the content or causes artifacts.
* **Recommendation:** Listen to `SDL_WINDOWEVENT_RESIZED` and update the viewport/state. (Can be deferred to Task 2.3).

## 4. Architecture Compliance (ADR-005)

* **Producer-Consumer Model:** âœ… COMPLIANT. The `Job_Queue` effectively decouples the rendering loop from the worker.
* **PBO Strategy:** âœ… COMPLIANT. The PBO is allocated with `GL_STREAM_DRAW` and bound as `GL_PIXEL_UNPACK_BUFFER` during texture update.
* **Zero-Copy Intent:** âœ… COMPLIANT. The structure allows for CUDA to map this PBO pointer later (Task 3.1).

## 5. Action Plan (Hotfixes)

The following changes are required before closing Task 2.1:
1.  **Refactor `Orchestrator.adb`**: Remove `Unchecked_Conversion`. Use strict typing for passing `Queue` and `Context` to the worker.
2.  **Implement Cleanup**: Expand `Shutdown` to free all GL resources.
